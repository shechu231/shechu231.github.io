
<!DOCTYPE html>
<html lang="en" class="loading">
<head>
    <meta charset="UTF-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1" />
    <meta name="viewport" content="width=device-width, minimum-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>redis学习记录 - Hexo</title>
    <meta name="apple-mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="google" content="notranslate" />
    <meta name="keywords" content="Fechin,"> 
    <meta name="description" content="背景我们现在的项目架构中，基本上是Web服务器(Tomcat)和数据库独立部署，独占服务器资源，随着用户数的增长，并发读写数据库，会加大数据库访问压力，导致性能的下降，严重时直接导致系统宕机，例如：,"> 
    <meta name="author" content="John Doe"> 
    <link rel="alternative" href="atom.xml" title="Hexo" type="application/atom+xml"> 
    
    
    
    
    <meta name="twitter:card" content="summary"/>
    <meta name="twitter:title" content="redis学习记录 - Hexo"/>
    <meta name="twitter:description" content="背景我们现在的项目架构中，基本上是Web服务器(Tomcat)和数据库独立部署，独占服务器资源，随着用户数的增长，并发读写数据库，会加大数据库访问压力，导致性能的下降，严重时直接导致系统宕机，例如：,"/>
    
    
    
    
    <meta property="og:site_name" content="Hexo"/>
    <meta property="og:type" content="object"/>
    <meta property="og:title" content="redis学习记录 - Hexo"/>
    <meta property="og:description" content="背景我们现在的项目架构中，基本上是Web服务器(Tomcat)和数据库独立部署，独占服务器资源，随着用户数的增长，并发读写数据库，会加大数据库访问压力，导致性能的下降，严重时直接导致系统宕机，例如：,"/>
    
<link rel="stylesheet" href="/css/diaspora.css">

<meta name="generator" content="Hexo 5.4.0"></head>

<body class="loading">
    <span id="config-title" style="display:none">Hexo</span>
    <div id="loader"></div>
    <div id="single">
    <div id="top" style="display: block;">
    <div class="bar" style="width: 0;"></div>
    <a class="iconfont icon-home image-icon" href="javascript:;" data-url="http://example.com"></a>
    <div title="播放/暂停" class="iconfont icon-play"></div>
    <h3 class="subtitle">redis学习记录</h3>
    <div class="social">
        <div>
            <div class="share">
                <a title="获取二维码" class="iconfont icon-scan" href="javascript:;"></a>
            </div>
            <div id="qr"></div>
        </div>
    </div>
    <div class="scrollbar"></div>
</div>

    <div class="section">
        <div class="article">
    <div class='main'>
        <h1 class="title">redis学习记录</h1>
        <div class="stuff">
            <span>一月 10, 2022</span>
            

        </div>
        <div class="content markdown">
            <h2 id="背景"><a href="#背景" class="headerlink" title="背景"></a>背景</h2><p>我们现在的项目架构中，基本上是Web服务器(Tomcat)和数据库独立部署，独占服务器资源，随着用户数的增长，并发读写数据库，会加大数据库访问压力，导致性能的下降，严重时直接导致系统宕机，例如：</p>
<p><img src="https://s2.loli.net/2022/01/10/PE8UyVFnTjkDYbH.png" alt="image-20220110085503156"></p>
<p>此时，我们可以在Tomcat同服务器上中增加本地缓存，并在外部增加分布式缓存，缓存热门数据。也就是通过缓存能把绝大多数请求在读写数据库前拦截掉，大大降低数据库压力。例如：</p>
<p><img src="https://s2.loli.net/2022/01/10/URqzTxgJiol79Od.png" alt="image-20220110085531848"></p>
<p>基于这样的一种架构设计，于是类似redis的一些分布式数据库就诞生了。</p>
<p>版本及参考说明<br>Redis的次版本号（第一个小数点后的数字）为偶数的版本是稳定版本（2.4、2.6等），奇数为非稳定版本（2.5、2.7），一般推荐在生产环境使用稳定版本。最新版本6.2.2，新增了stream的处理方式，性能更高。Redis官方是不支持windows平台的，windows版本是由微软自己建立的分支，基于官方的Redis源码上进行编译、发布、维护的，所以windows平台的Redis版本要略低于官方版本。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Redis 相关参考网址如下所示：</span><br><span class="line">Bootnb 相关：https://www.runoob.com/redis/redis-tutorial.html</span><br><span class="line">Redis 官网：https://redis.io/</span><br><span class="line">源码地址：https://github.com/redis/redis</span><br><span class="line">Redis 在线测试：http://try.redis.io/</span><br><span class="line">Redis 命令参考：http://doc.redisfans.com/</span><br></pre></td></tr></table></figure>

<p>在JAVA中连接redis:</p>
<p>首先安装在docker中安装redis:</p>
<p>导入redis依赖:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line">&lt;dependencies&gt;</span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;redis.clients&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;jedis&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;3.5.2&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;junit&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;junit&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;4.12&lt;/version&gt;</span><br><span class="line">            &lt;scope&gt;test&lt;/scope&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line"></span><br><span class="line">        &lt;dependency&gt;</span><br><span class="line">            &lt;groupId&gt;com.google.code.gson&lt;/groupId&gt;</span><br><span class="line">            &lt;artifactId&gt;gson&lt;/artifactId&gt;</span><br><span class="line">            &lt;version&gt;2.8.6&lt;/version&gt;</span><br><span class="line">        &lt;/dependency&gt;</span><br><span class="line">    &lt;/dependencies&gt;</span><br></pre></td></tr></table></figure>

<p>编写测试类:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">    public void testGetConnection()&#123;</span><br><span class="line">        //假如不能连通,要注释掉redis.conf中 bind 127.0.0.1,</span><br><span class="line">        //并将protected-mode的值修改为no,然后重启redis再试</span><br><span class="line">        Jedis jedis=new Jedis(&quot;192.168.199.130&quot;,6379);</span><br><span class="line">        //jedis.auth(&quot;123456&quot;);//假如在redis.conf中设置了密码</span><br><span class="line">        String ping = jedis.ping();</span><br><span class="line">        System.out.println(ping);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>常用方法总和:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br></pre></td><td class="code"><pre><span class="line">单点登录：</span><br><span class="line">public String doLogin(String username,String password)&#123;</span><br><span class="line">        Jedis jedis = new Jedis(&quot;192.168.199.130&quot;,6379);</span><br><span class="line">        if(!username.equals(&quot;admin&quot;))&#123;</span><br><span class="line">            System.out.println(&quot;账号不存在&quot;);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        if (!password.equals(&quot;123456&quot;))&#123;</span><br><span class="line">            System.out.println(&quot;密码错误&quot;);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        String token = UUID.randomUUID().toString();</span><br><span class="line"></span><br><span class="line">        jedis.hset(token,&quot;username&quot;,username);//把值存在token中，以key:value的形式</span><br><span class="line">        jedis.hset(token,&quot;permission&quot;,&quot;sys:resource:create&quot;);</span><br><span class="line">        jedis.expire(token,10);//设置值的有效期</span><br><span class="line">        jedis.close();</span><br><span class="line">        return token;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String doGetResource(String token)&#123;</span><br><span class="line">        if(token==null)&#123;</span><br><span class="line">            System.out.println(&quot;token为空&quot;);</span><br><span class="line">            return null;</span><br><span class="line">        &#125;</span><br><span class="line">        Jedis jedis = new Jedis(&quot;192.168.199.130&quot;,6379);</span><br><span class="line">        String username = jedis.hget(token, &quot;username&quot;);//获取值</span><br><span class="line">        String permission = jedis.hget(token, &quot;permission&quot;);//获取许可</span><br><span class="line"></span><br><span class="line">        jedis.close();</span><br><span class="line">        return permission;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line">    @Test</span><br><span class="line">    public void doit()&#123;</span><br><span class="line">        String token = doLogin(&quot;admin&quot;, &quot;123456&quot;);</span><br><span class="line">        System.out.println(token);</span><br><span class="line">        String resource = doGetResource(token);</span><br><span class="line">        System.out.println(resource);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">投票系统:</span><br><span class="line">//获取成员</span><br><span class="line">    public Set&lt;String&gt; doGetMembers(String activityId)&#123;</span><br><span class="line">        Jedis jedis = new Jedis(&quot;192.168.199.130&quot;,6379);</span><br><span class="line">        Set&lt;String&gt; smembers = jedis.smembers(activityId);//判断是否有相关活动id的成员</span><br><span class="line">        jedis.close();</span><br><span class="line">        return smembers;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    //获取票的总数总数</span><br><span class="line">    public Long doCount(String activityId)&#123;</span><br><span class="line">        Jedis jedis=new Jedis(&quot;192.168.199.130&quot;, 6379);</span><br><span class="line">        //2.获取当前活动的总票数</span><br><span class="line">        Long count=jedis.scard(activityId);</span><br><span class="line">        //3.释放资源</span><br><span class="line">        jedis.close();</span><br><span class="line">        return count;</span><br><span class="line">    &#125;</span><br><span class="line">    //投票</span><br><span class="line">    public String doVote(String activityId,String userId)&#123;</span><br><span class="line"></span><br><span class="line">        //1.建立连接</span><br><span class="line">        Jedis jedis=new Jedis(&quot;192.168.199.130&quot;, 6379);</span><br><span class="line">        //2.执行投票</span><br><span class="line">        //2.1检查是否投过票</span><br><span class="line">        Boolean flag = jedis.sismember(activityId, userId);</span><br><span class="line"></span><br><span class="line">        //2.2执行投票或取消投票</span><br><span class="line">        if(flag)&#123;</span><br><span class="line">            //假如已经投过票,再投票就取消投票</span><br><span class="line">//            jedis.srem(activityId, userId);//以列表的形式移除数据</span><br><span class="line">            System.out.println(&quot;已经投过票了&quot;);</span><br><span class="line">        &#125;else&#123;</span><br><span class="line">            //没有投过票则执行投票</span><br><span class="line">            jedis.sadd(activityId, userId);//以列表的形式存储数据</span><br><span class="line">        &#125;</span><br><span class="line">        //3.释放资源</span><br><span class="line">        jedis.close();</span><br><span class="line">        return &quot;投票成功&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    @Test</span><br><span class="line">    public void main() &#123;</span><br><span class="line">        String activityId=&quot;101&quot;;</span><br><span class="line">        String userId1=&quot;1&quot;;</span><br><span class="line">        String userId2=&quot;2&quot;;</span><br><span class="line">        String userId3=&quot;3&quot;;</span><br><span class="line">        //执行投票动作</span><br><span class="line">        doVote(activityId, userId1);</span><br><span class="line">        doVote(activityId, userId2);</span><br><span class="line">        doVote(activityId, userId3);</span><br><span class="line">        //获取投票的总票数</span><br><span class="line">        Long aLong = doCount(activityId);</span><br><span class="line">        System.out.println(aLong);</span><br><span class="line">        //获取参与投票的成员</span><br><span class="line">        Set&lt;String&gt; members= doGetMembers(activityId);</span><br><span class="line">        System.out.println(members);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">消息队列:</span><br><span class="line">public String enque(String msg)&#123;</span><br><span class="line">        Jedis jedis = new Jedis(&quot;192.168.199.130&quot;,6379);</span><br><span class="line">        jedis.lpush(&quot;queue&quot;,msg);//队列尾部存储</span><br><span class="line">        jedis.close();</span><br><span class="line">        return &quot;添加成功:&quot;+msg;</span><br><span class="line">    &#125;</span><br><span class="line">    public String deque()&#123;</span><br><span class="line">        Jedis jedis = new Jedis(&quot;192.168.199.130&quot;,6379);</span><br><span class="line">        String queue = jedis.lpop(&quot;queue&quot;);//队列移除队头</span><br><span class="line">        jedis.close();</span><br><span class="line">        return queue;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void main() throws InterruptedException &#123;</span><br><span class="line">        new Thread(()-&gt;&#123;</span><br><span class="line">            for(int i=0;i&lt;=10;i++)&#123;</span><br><span class="line">                try &#123;</span><br><span class="line">                    Thread.sleep(1000);</span><br><span class="line">                    String enque = enque(&quot;消息:&quot; + String.valueOf(i));</span><br><span class="line">                    System.out.println(enque);</span><br><span class="line"></span><br><span class="line">                &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                    e.printStackTrace();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line"></span><br><span class="line">        new Thread(()-&gt;&#123;</span><br><span class="line">            for (;;)&#123;</span><br><span class="line"></span><br><span class="line">                String msg = deque();</span><br><span class="line">                if(msg==null)&#123;</span><br><span class="line">                    try &#123;</span><br><span class="line">                        Thread.sleep(500);</span><br><span class="line"></span><br><span class="line">                    &#125; catch (InterruptedException e) &#123;</span><br><span class="line">                        e.printStackTrace();</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;else &#123;</span><br><span class="line">                    System.out.println(&quot;取出消息:&quot; + msg);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;).start();</span><br><span class="line">        Thread.sleep(20000);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">购物车:</span><br><span class="line">public static void addCart(Long userId,Long productId,int num)&#123;</span><br><span class="line">        //1.建立redis链接</span><br><span class="line">        Jedis jedis=new Jedis(&quot;192.168.199.130&quot;,6379);</span><br><span class="line">//        jedis.auth(&quot;123456&quot;);</span><br><span class="line">        //2.向购物车添加商品</span><br><span class="line">        //hincrBy这个函数在key不存在时会自动创建key</span><br><span class="line">        jedis.hincrBy(&quot;cart:&quot; + userId, String.valueOf(productId),num);//每次加上这个数，key:value形式</span><br><span class="line">        //3.释放redis链接</span><br><span class="line">        jedis.close();</span><br><span class="line">    &#125;</span><br><span class="line">    //查看我的购物车</span><br><span class="line">    public static Map&lt;String, String&gt; listCart(Long userId)&#123;</span><br><span class="line">        //1.建立redis链接</span><br><span class="line">        Jedis jedis=new Jedis(&quot;192.168.199.130&quot;,6379);</span><br><span class="line">//        jedis.auth(&quot;123456&quot;);</span><br><span class="line">        //2.查看购物车商品</span><br><span class="line">        Map&lt;String, String&gt; map = jedis.hgetAll(&quot;cart:&quot; + userId);//查询购物车商品</span><br><span class="line">        //3.释放redis链接</span><br><span class="line">        jedis.close();</span><br><span class="line">        return map;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Test</span><br><span class="line">    public void main() &#123;</span><br><span class="line">        //1.向购物车添加商品</span><br><span class="line">        addCart(101L,201L,1);</span><br><span class="line">        addCart(101L,202L,1);</span><br><span class="line">        addCart(101L,203L,2);</span><br><span class="line">        //2.查看购物车商品</span><br><span class="line">        Map&lt;String, String&gt; map = listCart(101L);</span><br><span class="line">            System.out.println(map);</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>

<p>Redis 相关参考网址如下所示：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">Bootnb 相关：https://www.runoob.com/redis/redis-tutorial.html</span><br><span class="line">Redis 官网：https://redis.io/</span><br><span class="line">源码地址：https://github.com/redis/redis</span><br><span class="line">Redis 在线测试：http://try.redis.io/</span><br><span class="line">Redis 命令参考：http://doc.redisfans.com/</span><br></pre></td></tr></table></figure>

<h2 id="Redis-是单线程的！"><a href="#Redis-是单线程的！" class="headerlink" title="Redis 是单线程的！"></a>Redis 是单线程的！</h2><p>明白Redis是很快的，官方表示，Redis是基于内存操作，CPU不是Redis性能瓶颈，Redis的瓶颈是根据</p>
<p>机器的内存和网络带宽，既然可以使用单线程来实现，就使用单线程了！所有就使用了单线程了！</p>
<p>Redis 是C 语言写的，官方提供的数据为 100000+ 的QPS，完全不比同样是使用 key-vale的</p>
<p>Memecache差！</p>
<p><strong>Redis</strong> <strong>为什么单线程还这么快？</strong></p>
<p>1、误区1：高性能的服务器一定是多线程的？</p>
<p>2、误区2：多线程（CPU上下文会切换！）一定比单线程效率高！</p>
<p>先去CPU&gt;内存&gt;硬盘的速度要有所了解！</p>
<p>核心：redis 是将所有的数据全部放在内存中的，所以说使用单线程去操作效率就是最高的，多线程</p>
<p>（CPU上下文会切换：耗时的操作！！！），对于内存系统来说，如果没有上下文切换效率就是最高</p>
<p>的！多次读写都是在一个CPU上的，在内存情况下，这个就是最佳的方案！</p>
<h1 id="五大数据类型"><a href="#五大数据类型" class="headerlink" title="五大数据类型"></a>五大数据类型</h1><p>Redis 是一个开源（BSD许可）的，内存中的数据结构存储系统，它可以用作数据库、缓存和消息中间</p>
<p>件MQ。 它支持多种类型的数据结构，如 字符串（strings）， 散列（hashes）， 列表（lists）， 集合（sets）， 有序集合（sorted sets） 与范围查询， bitmaps， hyperloglogs 和 地理空间（geospatial） 索引半径查询。 Redis 内置了 复制（replication），LUA脚本（Lua scripting）， LRU驱动事件（LRU eviction），事务（transactions） 和不同级别的 磁盘持久化（persistence）， 并通过Redis哨兵（Sentinel）和自动 分区（Cluster）提供高可用性（high availability）。</p>
<h1 id="Redis初始操作"><a href="#Redis初始操作" class="headerlink" title="Redis初始操作"></a>Redis初始操作</h1><h3 id="启动redis服务"><a href="#启动redis服务" class="headerlink" title="启动redis服务"></a>启动redis服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker start redis01 #底层也是通过redis-server启动，start单词后的redis01为容器名</span><br></pre></td></tr></table></figure>

<p>docker 中查看redis 服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps</span><br></pre></td></tr></table></figure>

<p>查看启动的redis进程信息</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">ps -ef|grep redis</span><br><span class="line">root      3511     1  0 16:29 ?   00:00:01 redis-server *:6379</span><br><span class="line">root      3515     1  0 16:29 ?   00:00:01 redis-server 127.0.0.1:6380</span><br></pre></td></tr></table></figure>

<h2 id="进入redis容器"><a href="#进入redis容器" class="headerlink" title="进入redis容器"></a>进入redis容器</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis01 bash #redis01 为容器名</span><br></pre></td></tr></table></figure>

<h3 id="登陆redis服务"><a href="#登陆redis服务" class="headerlink" title="登陆redis服务"></a>登陆redis服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">redis-cli</span><br><span class="line">或者</span><br><span class="line">redis-cli -p 6379</span><br><span class="line">或者</span><br><span class="line">redis-cli -p 6379 -a  password #-a后面为password,此操作需要开启redis.conf文件中的 requirepass选项</span><br></pre></td></tr></table></figure>

<p>登陆远程redis</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli  -h ip  -p 6379  -a  password</span><br></pre></td></tr></table></figure>

<h3 id="查看redis信息"><a href="#查看redis信息" class="headerlink" title="查看redis信息"></a>查看redis信息</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info		#查看当前redis节点的详细配置信息</span><br></pre></td></tr></table></figure>

<h3 id="清空redis屏幕"><a href="#清空redis屏幕" class="headerlink" title="清空redis屏幕"></a>清空redis屏幕</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; clear</span><br></pre></td></tr></table></figure>

<h3 id="退出redis服务"><a href="#退出redis服务" class="headerlink" title="退出redis服务"></a>退出redis服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; exit</span><br></pre></td></tr></table></figure>

<h3 id="关闭redis服务"><a href="#关闭redis服务" class="headerlink" title="关闭redis服务"></a>关闭redis服务</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; shutdown</span><br></pre></td></tr></table></figure>

<h3 id="系统帮助"><a href="#系统帮助" class="headerlink" title="系统帮助"></a>系统帮助</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; help</span><br><span class="line">redis-cli 2.8.19</span><br><span class="line">Type: &quot;help @&lt;group&gt;&quot; to get a list of commands in &lt;group&gt;</span><br><span class="line">      &quot;help &lt;command&gt;&quot; for help on &lt;command&gt;</span><br><span class="line">      &quot;help &lt;tab&gt;&quot; to get a list of possible help topics</span><br><span class="line">      &quot;quit&quot; to exit</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; help type</span><br><span class="line">  TYPE key</span><br><span class="line">  summary: Determine the type stored at key</span><br><span class="line">  since: 1.0.0</span><br><span class="line">  group: generic</span><br></pre></td></tr></table></figure>

<h2 id="Redis数据存储操作"><a href="#Redis数据存储操作" class="headerlink" title="Redis数据存储操作"></a>Redis数据存储操作</h2><h3 id="简易数据存取"><a href="#简易数据存取" class="headerlink" title="简易数据存取"></a>简易数据存取</h3><p>基于查看redis中的key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty list or set)</span><br></pre></td></tr></table></figure>

<p>基于key/value形式存储数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set test1 123</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set test2 ab</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;test1&quot;</span><br><span class="line">2) &quot;test2&quot;</span><br></pre></td></tr></table></figure>

<p>基于key获取redis中存储的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get test1</span><br><span class="line">&quot;123&quot;</span><br></pre></td></tr></table></figure>

<p>清除redis中的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; flushdb</span><br><span class="line">OK</span><br></pre></td></tr></table></figure>

<h3 id="Key有效时间设计"><a href="#Key有效时间设计" class="headerlink" title="Key有效时间设计"></a>Key有效时间设计</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">Expire (设置生效时长-单位秒)</span><br><span class="line"></span><br><span class="line">127.0.0.1:6379&gt; set bomb tnt</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; expire bomb 10</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl bomb</span><br><span class="line">(integer) 5</span><br><span class="line">其中,TTL查看key的剩余时间，当返回值为-2时，表示键被删除。</span><br><span class="line">当 key 不存在时，返回 -2 。 当 key 存在但没有设置剩余生存时间时，返回 -1 。</span><br><span class="line">Persist (取消时长设置)</span><br></pre></td></tr></table></figure>

<p>Persist (取消时长设置)</p>
<p>语法：PERSIST key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set bomb tnt</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; expire bomb 60</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl bomb</span><br><span class="line">(integer) 49</span><br><span class="line">127.0.0.1:6379&gt; persist bomb</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl bomb</span><br><span class="line">(integer) -1</span><br></pre></td></tr></table></figure>

<p>其中,设置新的数据时需要重新设置该key的生存时间，重新设置值也会清除生存时间。</p>
<p>pexpire （单位毫秒）</p>
<p>语法：PEXPIRE key milliseconds</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set bomb tnt</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; pexpire bomb 10000</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; ttl bomb</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; ttl bomb</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; ttl bomb</span><br><span class="line">(integer) -2</span><br></pre></td></tr></table></figure>

<h2 id="Redis数据类型操作"><a href="#Redis数据类型操作" class="headerlink" title="Redis数据类型操作"></a>Redis数据类型操作</h2><h3 id="String类型操作实践"><a href="#String类型操作实践" class="headerlink" title="String类型操作实践"></a>String类型操作实践</h3><h4 id="incr-incrby"><a href="#incr-incrby" class="headerlink" title="incr/incrby"></a>incr/incrby</h4><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set num 1</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; incr num</span><br><span class="line">(integer) 2</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;num&quot;	</span><br><span class="line">127.0.0.1:6379&gt; incr num</span><br><span class="line">指定增长系数</span><br><span class="line">127.0.0.1:6379&gt; incrby num 2</span><br><span class="line">(integer) 5</span><br><span class="line">127.0.0.1:6379&gt; incrby num 2</span><br><span class="line">(integer) 7</span><br><span class="line">127.0.0.1:6379&gt; incrby num 2</span><br><span class="line">(integer) 9</span><br></pre></td></tr></table></figure>

<p>说明，如果num不存在，则自动会创建，如果存在自动+1。</p>
<h3 id="decr-decrby"><a href="#decr-decrby" class="headerlink" title="decr/decrby"></a>decr/decrby</h3><p>减少指定的整数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; incr num</span><br><span class="line">(integer) 10</span><br><span class="line">127.0.0.1:6379&gt; decr num</span><br><span class="line">(integer) 9</span><br><span class="line">127.0.0.1:6379&gt; decrby num 3</span><br></pre></td></tr></table></figure>

<h3 id="append"><a href="#append" class="headerlink" title="append"></a>append</h3><p>向尾部追加值。如果键不存在则创建该键，其值为写的value，即相当于SET key value。返回值是追加后字符串的总长度。<br>语法：APPEND key value</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">1) &quot;num&quot;</span><br><span class="line">2) &quot;test1&quot;</span><br><span class="line">3) &quot;test&quot;</span><br><span class="line">127.0.0.1:6379&gt; get test</span><br><span class="line">&quot;123&quot;</span><br><span class="line">127.0.0.1:6379&gt; append test &quot;abc&quot;</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; get test</span><br><span class="line">&quot;123abc&quot;</span><br></pre></td></tr></table></figure>

<h3 id="strlen"><a href="#strlen" class="headerlink" title="strlen"></a>strlen</h3><p>字符串长度，返回数据的长度，如果键不存在则返回0。注意，如果键值为空串，返回也是0。<br>语法：STRLEN key</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; get test</span><br><span class="line">&quot;123abc&quot;</span><br><span class="line">127.0.0.1:6379&gt; strlen test</span><br><span class="line">(integer) 6</span><br><span class="line">127.0.0.1:6379&gt; strlen tnt</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; set tnt &quot;&quot;</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; strlen tnt</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; exists tnt</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<h3 id="mset-mget"><a href="#mset-mget" class="headerlink" title="mset/mget"></a>mset/mget</h3><p>同时设置/获取多个键值<br>语法：MSET key value [key value …]<br>MGET key [key …]</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; flushall</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; keys *</span><br><span class="line">(empty list or set)</span><br><span class="line">127.0.0.1:6379&gt; mset a 1 b 2 c 3</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget a b c</span><br><span class="line">1) &quot;1&quot;</span><br><span class="line">2) &quot;2&quot;</span><br><span class="line">3) &quot;3&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Hash类型应用实践"><a href="#Hash类型应用实践" class="headerlink" title="Hash类型应用实践"></a>Hash类型应用实践</h3><p>Redis散列类型相当于Java中的HashMap，实现原理跟HashMap一致,一般用于存储对象信息，存储了字段（field）和字段值的映射，一个散列类型可以包含最多232-1个字段。</p>
<h3 id="hset-hget"><a href="#hset-hget" class="headerlink" title="hset/hget"></a>hset/hget</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">HSET key field value</span><br><span class="line">HGET key field</span><br><span class="line">HMSET key field value [field value…]</span><br><span class="line">HMGET key field [field]</span><br><span class="line">HGETALL key</span><br></pre></td></tr></table></figure>

<p>HSET和HGET赋值和取值</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hset user username chenchen</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hget user username</span><br><span class="line">&quot;chenchen&quot;</span><br><span class="line">127.0.0.1:6379&gt; hset user username chen</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; keys user</span><br><span class="line">1) &quot;user&quot;</span><br><span class="line">127.0.0.1:6379&gt; hgetall user</span><br><span class="line">1) &quot;username&quot;</span><br><span class="line">2) &quot;chen&quot;</span><br><span class="line">127.0.0.1:6379&gt; hset user age 18</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hset user address &quot;xi&#x27;an&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall user</span><br><span class="line">1) &quot;username&quot;</span><br><span class="line">2) &quot;chen&quot;</span><br><span class="line">3) &quot;age&quot;</span><br><span class="line">4) &quot;18&quot;</span><br><span class="line">3) &quot;address&quot;</span><br><span class="line">4) &quot;xi&#x27;an&quot;</span><br></pre></td></tr></table></figure>

<p>HSET命令不区分插入和更新操作，当执行插入操作时HSET命令返回1，当执行更新操作时返回0。</p>
<h3 id="hincrby"><a href="#hincrby" class="headerlink" title="hincrby"></a>hincrby</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hdecrby article total 1		#执行会出错</span><br><span class="line">127.0.0.1:6379&gt; hincrby article total -1		#没有hdecrby自减命令</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hget article total			#获取值</span><br></pre></td></tr></table></figure>

<h3 id="hmset-hmget"><a href="#hmset-hmget" class="headerlink" title="hmset/hmget"></a>hmset/hmget</h3><p>HMSET和HMGET设置和获取对象属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hmset person username tony age 18</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; hmget person age username</span><br><span class="line">1) &quot;18&quot;</span><br><span class="line">2) &quot;tony&quot;</span><br><span class="line">127.0.0.1:6379&gt; hgetall person</span><br><span class="line">1) &quot;username&quot;</span><br><span class="line">2) &quot;tony&quot;</span><br><span class="line">3) &quot;age&quot;</span><br><span class="line">4) &quot;18&quot;</span><br></pre></td></tr></table></figure>

<p>注意：上面HMGET字段顺序可以自行定义</p>
<h3 id="hexists"><a href="#hexists" class="headerlink" title="hexists"></a>hexists</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">属性是否存在</span><br><span class="line">127.0.0.1:6379&gt; hexists killer</span><br><span class="line">(error) ERR wrong number of arguments for &#x27;hexists&#x27; command</span><br><span class="line">127.0.0.1:6379&gt; hexists killer a</span><br><span class="line">(integer) 0</span><br><span class="line">127.0.0.1:6379&gt; hexists user username</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hexists person age</span><br><span class="line">(integer) 1</span><br></pre></td></tr></table></figure>

<h3 id="hdel"><a href="#hdel" class="headerlink" title="hdel"></a>hdel</h3><p>删除属性</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hdel user age</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hgetall user</span><br><span class="line">1) &quot;username&quot;</span><br><span class="line">2) &quot;chen&quot;</span><br><span class="line">127.0.0.1:6379&gt; hgetall person</span><br><span class="line">1) &quot;username&quot;</span><br><span class="line">2) &quot;tony&quot;</span><br><span class="line">3) &quot;age&quot;</span><br><span class="line">4) &quot;18&quot;</span><br></pre></td></tr></table></figure>

<h3 id="hkeys-hvals"><a href="#hkeys-hvals" class="headerlink" title="hkeys/hvals"></a>hkeys/hvals</h3><p>只获取字段名HKEYS或字段值HVALS</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; hkeys person</span><br><span class="line">1) &quot;username&quot;</span><br><span class="line">2) &quot;age&quot;</span><br><span class="line">127.0.0.1:6379&gt; hvals person</span><br><span class="line">1) &quot;tony&quot;</span><br><span class="line">2) &quot;18&quot;</span><br><span class="line">2.3.8	hlen</span><br><span class="line">元素个数</span><br><span class="line">127.0.0.1:6379&gt; hlen user</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; hlen person</span><br><span class="line">(integer) 2</span><br></pre></td></tr></table></figure>

<h2 id="List类型应用实践"><a href="#List类型应用实践" class="headerlink" title="List类型应用实践"></a>List类型应用实践</h2><h3 id="lpush"><a href="#lpush" class="headerlink" title="lpush"></a>lpush</h3><p>在key对应list的头部添加字符串元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; lpush mylist &quot;world&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; lpush mylist &quot;hello&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist 0 -1</span><br><span class="line">1) &quot;hello&quot;</span><br><span class="line">2) &quot;world&quot;</span><br></pre></td></tr></table></figure>

<p>其中，Redis Lrange 返回列表中指定区间内的元素，区间以偏移量 START 和 END 指定。 其中 0 表示列表的第一个元素， 1 表示列表的第二个元素，以此类推。 你也可以使用负数下标，以 -1 表示列表的最后一个元素， -2 表示列表的倒数第二个元素，以此类推</p>
<h2 id="rpush"><a href="#rpush" class="headerlink" title="rpush"></a>rpush</h2><p>在key对应list的尾部添加字符串元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; rpush mylist2 &quot;hello&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist2 &quot;world&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist2 0 -1</span><br><span class="line">1) &quot;hello&quot;</span><br><span class="line">2) &quot;world&quot;</span><br></pre></td></tr></table></figure>

<h2 id="del"><a href="#del" class="headerlink" title="del"></a>del</h2><p>清空集合元素，例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; del mylist</span><br></pre></td></tr></table></figure>

<h2 id="insert"><a href="#insert" class="headerlink" title="insert"></a>insert</h2><p>在key对应list的特定位置之前或之后添加字符串元素</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; rpush mylist3 &quot;hello&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist3 &quot;world&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; linsert mylist3 before &quot;world&quot; &quot;there&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist3 0 -1</span><br><span class="line">1) &quot;hello&quot;</span><br><span class="line">2) &quot;there&quot;</span><br><span class="line">3) &quot;world&quot;</span><br></pre></td></tr></table></figure>

<h2 id="lset"><a href="#lset" class="headerlink" title="lset"></a>lset</h2><p>设置list中指定下标的元素值(一般用于修改操作)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; rpush mylist4 &quot;one&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist4 &quot;two&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist4 &quot;three&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">redis 127.0.0.1:6379&gt; lset mylist4 0 &quot;four&quot;</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; lset mylist4 -2 &quot;five&quot;</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist4 0 -1</span><br><span class="line">1) &quot;four&quot;</span><br><span class="line">2) &quot;five&quot;</span><br><span class="line">3) &quot;three&quot;</span><br></pre></td></tr></table></figure>

<h2 id="lrem"><a href="#lrem" class="headerlink" title="lrem"></a>lrem</h2><p>从key对应list中删除count个和value相同的元素，count&gt;0时，按从头到尾的顺序删除</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; rpush mylist5 &quot;hello&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist5 &quot;hello&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist5 &quot;foo&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist5 &quot;hello&quot;</span><br><span class="line">(integer) 4</span><br><span class="line">redis 127.0.0.1:6379&gt; lrem mylist5 2 &quot;hello&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist5 0 -1</span><br><span class="line">1) &quot;foo&quot;</span><br><span class="line">2) &quot;hello&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt;</span><br><span class="line">count&lt;0时，按从尾到头的顺序删除</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist6 &quot;hello&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist6 &quot;hello&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist6 &quot;foo&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist6 &quot;hello&quot;</span><br><span class="line">(integer) 4</span><br><span class="line">redis 127.0.0.1:6379&gt; lrem mylist6 -2 &quot;hello&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist6 0 -1</span><br><span class="line">1) &quot;hello&quot;</span><br><span class="line">2) &quot;foo&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt;</span><br><span class="line">count=0时，删除全部</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist7 &quot;hello&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist7 &quot;hello&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist7 &quot;foo&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist7 &quot;hello&quot;</span><br><span class="line">(integer) 4</span><br><span class="line">redis 127.0.0.1:6379&gt; lrem mylist7 0 &quot;hello&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist7 0 -1</span><br><span class="line">1) &quot;foo&quot;</span><br></pre></td></tr></table></figure>

<h2 id="ltrim"><a href="#ltrim" class="headerlink" title="ltrim"></a>ltrim</h2><p>保留指定key 的值范围内的数据</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; rpush mylist8 &quot;one&quot;</span><br><span class="line">(integer) 1</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist8 &quot;two&quot;</span><br><span class="line">(integer) 2</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist8 &quot;three&quot;</span><br><span class="line">(integer) 3</span><br><span class="line">redis 127.0.0.1:6379&gt; rpush mylist8 &quot;four&quot;</span><br><span class="line">(integer) 4</span><br><span class="line">redis 127.0.0.1:6379&gt; ltrim mylist8 1 -1</span><br><span class="line">OK</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist8 0 -1</span><br><span class="line">1) &quot;two&quot;</span><br><span class="line">2) &quot;three&quot;</span><br><span class="line">3) &quot;four&quot;</span><br></pre></td></tr></table></figure>

<h2 id="lpop"><a href="#lpop" class="headerlink" title="lpop"></a>lpop</h2><p>从list的尾部删除元素，并返回删除元素：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; lrange mylist2 0 -1</span><br><span class="line">1) &quot;hello&quot;</span><br><span class="line">2) &quot;world&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; rpop mylist2</span><br><span class="line">&quot;world&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist2 0 -1</span><br><span class="line">1) &quot;hello&quot;</span><br></pre></td></tr></table></figure>

<h2 id="rpop"><a href="#rpop" class="headerlink" title="rpop"></a>rpop</h2><p>从list的尾部删除元素，并返回删除元素：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; lrange mylist2 0 -1</span><br><span class="line">1) &quot;hello&quot;</span><br><span class="line">2) &quot;world&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; rpop mylist2</span><br><span class="line">&quot;world&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; lrange mylist2 0 -1</span><br><span class="line">1) &quot;hello&quot;</span><br></pre></td></tr></table></figure>

<h2 id="llen"><a href="#llen" class="headerlink" title="llen"></a>llen</h2><p>返回key对应list的长度：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; llen mylist5</span><br><span class="line">(integer) 2</span><br></pre></td></tr></table></figure>

<h2 id="lindex"><a href="#lindex" class="headerlink" title="lindex"></a>lindex</h2><p>返回名称为key的list中index位置的元素：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">redis 127.0.0.1:6379&gt; lrange mylist5 0 -1</span><br><span class="line">1) &quot;three&quot;</span><br><span class="line">2) &quot;foo&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; lindex mylist5 0</span><br><span class="line">&quot;three&quot;</span><br><span class="line">redis 127.0.0.1:6379&gt; lindex mylist5 1</span><br><span class="line">&quot;foo&quot;</span><br></pre></td></tr></table></figure>

<h2 id="rpoplpush"><a href="#rpoplpush" class="headerlink" title="rpoplpush"></a>rpoplpush</h2><p>从第一个list的尾部移除元素并添加到第二个list的头部,最后返回被移除的元素值，整个操作是原子的.如果第一个list是空或者不存在返回nil：<br>rpoplpush lst1 lst1<br>rpoplpush lst1 lst2</p>
<h2 id="Set类型应用实践"><a href="#Set类型应用实践" class="headerlink" title="Set类型应用实践"></a>Set类型应用实践</h2><p>Redis的Set类似Java中的HashSet，是string类型的无序集合。集合成员是唯一的，这就意味着集合中不能出现重复的数据。Redis中Set集合是通过哈希表实现的，所以添加，删除，查找的复杂度都是O(1)。</p>
<h2 id="sadd"><a href="#sadd" class="headerlink" title="sadd"></a>sadd</h2><p>添加元素，重复元素添加失败，返回0</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd name tony</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd name hellen</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd name rose</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; sadd name rose</span><br><span class="line">(integer) 0</span><br></pre></td></tr></table></figure>

<h2 id="smembers"><a href="#smembers" class="headerlink" title="smembers"></a>smembers</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">获取集合中成员，例如</span><br><span class="line">127.0.0.1:6379&gt; smembers name</span><br></pre></td></tr></table></figure>

<h2 id="spop"><a href="#spop" class="headerlink" title="spop"></a>spop</h2><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; smembers internet</span><br><span class="line">1) &quot;amoeba&quot;</span><br><span class="line">2) &quot;redis&quot;</span><br><span class="line">3) &quot;rabbitmq&quot;</span><br><span class="line">4) &quot;nginx&quot;</span><br><span class="line">127.0.0.1:6379&gt; spop internet</span><br><span class="line">&quot;rabbitmq&quot;</span><br><span class="line">127.0.0.1:6379&gt; spop internet</span><br><span class="line">&quot;nginx&quot;</span><br><span class="line">127.0.0.1:6379&gt; smembers internet</span><br><span class="line">1) &quot;amoeba&quot;</span><br><span class="line">2) &quot;redis&quot;</span><br></pre></td></tr></table></figure>

<h2 id="scard"><a href="#scard" class="headerlink" title="scard"></a>scard</h2><p>获取集合中的成员个数</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; scard name</span><br><span class="line">(integer) 3</span><br></pre></td></tr></table></figure>

<h2 id="smove"><a href="#smove" class="headerlink" title="smove"></a>smove</h2><p>移动一个元素到另外一个集合</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sadd internet amoeba nginx redis</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; sadd bigdata hadopp spark rabbitmq</span><br><span class="line">(integer) 3</span><br><span class="line">127.0.0.1:6379&gt; smembers internet</span><br><span class="line">1) &quot;amoeba&quot;</span><br><span class="line">2) &quot;redis&quot;</span><br><span class="line">3) &quot;nginx&quot;</span><br><span class="line">127.0.0.1:6379&gt; smembers bigdata</span><br><span class="line">1) &quot;hadopp&quot;</span><br><span class="line">2) &quot;spark&quot;</span><br><span class="line">3) &quot;rabbitmq&quot;</span><br><span class="line">127.0.0.1:6379&gt; smove bigdata internet rabbitmq</span><br><span class="line">(integer) 1</span><br><span class="line">127.0.0.1:6379&gt; smembers internet</span><br><span class="line">1) &quot;amoeba&quot;</span><br><span class="line">2) &quot;redis&quot;</span><br><span class="line">3) &quot;rabbitmq&quot;</span><br><span class="line">4) &quot;nginx&quot;</span><br><span class="line">127.0.0.1:6379&gt; smembers bigdata</span><br><span class="line">1) &quot;hadopp&quot;</span><br><span class="line">2) &quot;spark&quot;</span><br></pre></td></tr></table></figure>

<h2 id="sunion"><a href="#sunion" class="headerlink" title="sunion"></a>sunion</h2><p>实现集合的并集操作</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; sunion internet bigdata</span><br><span class="line">1) &quot;redis&quot;</span><br><span class="line">2) &quot;nginx&quot;</span><br><span class="line">3) &quot;rabbitmq&quot;</span><br><span class="line">4) &quot;amoeba&quot;</span><br><span class="line">5) &quot;hadopp&quot;</span><br><span class="line">6) &quot;spark&quot;</span><br></pre></td></tr></table></figure>

<h3 id="Zset（有序集合）"><a href="#Zset（有序集合）" class="headerlink" title="Zset（有序集合）"></a>Zset（有序集合）</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; zadd myset 1 one # 添加一个值</span><br><span class="line">127.0.0.1:6379&gt; zadd myset 2 two 3 three # 添加多个值</span><br><span class="line">127.0.0.1:6379&gt; ZRANGEBYSCORE salary -inf +inf # 显示全部的用户 从小到大！</span><br><span class="line">127.0.0.1:6379&gt; ZREVRANGE salary 0 -1 # 从大到进行排序！</span><br></pre></td></tr></table></figure>



<h2 id="SpringBoot工程中Redis与Aop技术的整合"><a href="#SpringBoot工程中Redis与Aop技术的整合" class="headerlink" title="SpringBoot工程中Redis与Aop技术的整合"></a>SpringBoot工程中Redis与Aop技术的整合</h2><p>基于AOP与Redis技术实现mysql,redis数据库中数据操作.</p>
<h3 id="项目准备工作"><a href="#项目准备工作" class="headerlink" title="项目准备工作"></a>项目准备工作</h3><p>第一步:打开sca-template工程,添加访问MySql数据库的依赖(两个)</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">&lt;!--mysql依赖--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;mysql&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mysql-connector-java&lt;/artifactId&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br><span class="line">    &lt;!--mybatis plus (简化mybatis操作)--&gt;</span><br><span class="line">    &lt;dependency&gt;</span><br><span class="line">        &lt;groupId&gt;com.baomidou&lt;/groupId&gt;</span><br><span class="line">        &lt;artifactId&gt;mybatis-plus-boot-starter&lt;/artifactId&gt;</span><br><span class="line">        &lt;version&gt;3.4.2&lt;/version&gt;</span><br><span class="line">    &lt;/dependency&gt;</span><br></pre></td></tr></table></figure>

<p>第二步:修改配置文件,添加连接mysql数据库的配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  datasource:</span><br><span class="line">    url: jdbc:mysql:///jt-sso?serverTimezone=Asia/Shanghai&amp;characterEncoding=utf8</span><br><span class="line">    username: root</span><br><span class="line">    password: root</span><br></pre></td></tr></table></figure>

<h3 id="Pojo逻辑对象定义"><a href="#Pojo逻辑对象定义" class="headerlink" title="Pojo逻辑对象定义"></a>Pojo逻辑对象定义</h3><p>定义一个Menu对象,用户封装tb_menus表中的数据,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">package com.jt.pojo;</span><br><span class="line">import com.baomidou.mybatisplus.annotation.IdType;</span><br><span class="line">import com.baomidou.mybatisplus.annotation.TableId;</span><br><span class="line">import com.baomidou.mybatisplus.annotation.TableName;</span><br><span class="line">import org.springframework.data.annotation.Id;</span><br><span class="line"></span><br><span class="line">import java.io.Serializable;</span><br><span class="line"></span><br><span class="line">@TableName(value = &quot;tb_menus&quot;)</span><br><span class="line">public class Menu implements Serializable &#123;</span><br><span class="line">    private static final long serialVersionUID = -577747732166248365L;</span><br><span class="line">    @TableId(type = IdType.AUTO)</span><br><span class="line">    private Long id;</span><br><span class="line">    private String name;</span><br><span class="line">    private String permission;</span><br><span class="line"></span><br><span class="line">    public Long getId() &#123;</span><br><span class="line">        return id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setId(Long id) &#123;</span><br><span class="line">        this.id = id;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getName() &#123;</span><br><span class="line">        return name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setName(String name) &#123;</span><br><span class="line">        this.name = name;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public String getPermission() &#123;</span><br><span class="line">        return permission;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    public void setPermission(String permission) &#123;</span><br><span class="line">        this.permission = permission;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @Override</span><br><span class="line">    public String toString() &#123;</span><br><span class="line">        return &quot;Menu&#123;&quot; +</span><br><span class="line">                &quot;id=&quot; + id +</span><br><span class="line">                &quot;, name=&#x27;&quot; + name + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &quot;, permission=&#x27;&quot; + permission + &#x27;\&#x27;&#x27; +</span><br><span class="line">                &#x27;&#125;&#x27;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Dao逻辑对象设计及实现"><a href="#Dao逻辑对象设计及实现" class="headerlink" title="Dao逻辑对象设计及实现"></a>Dao逻辑对象设计及实现</h3><p>创建用于操作数据库中tb_menus表中数据的Mapper对象,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">package com.jt.dao;</span><br><span class="line"></span><br><span class="line">import com.baomidou.mybatisplus.core.mapper.BaseMapper;</span><br><span class="line">import com.jt.pojo.Menu;</span><br><span class="line">import org.apache.ibatis.annotations.Mapper;</span><br><span class="line"></span><br><span class="line">@Mapper</span><br><span class="line">public interface MenuMapper extends BaseMapper&lt;Menu&gt; &#123;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="Service逻辑对象设计及实现"><a href="#Service逻辑对象设计及实现" class="headerlink" title="Service逻辑对象设计及实现"></a>Service逻辑对象设计及实现</h3><p>第一步:定义用于处理菜单业务的业务接口,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line">package com.jt.service;</span><br><span class="line">import com.jt.pojo.Menu;</span><br><span class="line">import java.io.Serializable;</span><br><span class="line">public interface MenuService &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 基于id查找菜单对象,先查redis,redis没有再查数据库</span><br><span class="line">     * @param id</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    Menu selectById(Long id);</span><br><span class="line">    /**</span><br><span class="line">     * 向表中写入一条菜单信息,与此同时也要向redis写入一样的数据</span><br><span class="line">     * @param menu</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    Menu insertMenu(Menu menu);</span><br><span class="line">    /**</span><br><span class="line">     * 更新表中数据,与此同时也要更新redis中的数据</span><br><span class="line">     * @param menu</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    Menu updateMenu(Menu menu);</span><br><span class="line">    //.....</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>第二步:定义用于处理菜单业务的业务接口实现类,<br>在这个实现类中自己基于RedisTemplate对象操作Redis缓存,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br></pre></td><td class="code"><pre><span class="line">package com.jt.service;</span><br><span class="line">import com.jt.dao.MenuMapper;</span><br><span class="line">import com.jt.pojo.Menu;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.data.redis.core.ValueOperations;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line">import java.time.Duration;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class MenuServiceImpl implements MenuService&#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private MenuMapper menuMapper;</span><br><span class="line"></span><br><span class="line">   // @Autowired</span><br><span class="line">   // private RedisTemplate redisTemplate;</span><br><span class="line"></span><br><span class="line">    @Resource(name=&quot;redisTemplate&quot;)</span><br><span class="line">    private ValueOperations valueOperations;//从spring.io官方的data项目中去查这种注入方式</span><br><span class="line">    /**</span><br><span class="line">     * 基于id查询菜单信息,要求:</span><br><span class="line">     * 1)先查redis,redis没有去查mysql</span><br><span class="line">     * 2)将从mysql查询到的数据存储到redis</span><br><span class="line">     * @param id</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Override</span><br><span class="line">    public Menu selectById(Long id) &#123;</span><br><span class="line">        //ValueOperations valueOperations = redisTemplate.opsForValue();</span><br><span class="line">        Object obj=valueOperations.get(String.valueOf(id));</span><br><span class="line">        if(obj!=null)&#123;</span><br><span class="line">            System.out.println(&quot;Get Data from redis&quot;);</span><br><span class="line">            return (Menu)obj;</span><br><span class="line">        &#125;</span><br><span class="line">        Menu menu=menuMapper.selectById(id);</span><br><span class="line">        valueOperations.set(String.valueOf(id), menu, Duration.ofSeconds(120));</span><br><span class="line">        return menu;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Menu insertMenu(Menu menu) &#123;</span><br><span class="line">        menuMapper.insert(menu);</span><br><span class="line">       // ValueOperations valueOperations = redisTemplate.opsForValue();</span><br><span class="line">        valueOperations.set(String.valueOf(menu.getId()), menu, Duration.ofSeconds(120));</span><br><span class="line">        return menu;</span><br><span class="line">    &#125;</span><br><span class="line">    @Override</span><br><span class="line">    public Menu updateMenu(Menu menu) &#123;</span><br><span class="line">        menuMapper.updateById(menu);</span><br><span class="line">       // ValueOperations valueOperations = redisTemplate.opsForValue();</span><br><span class="line">        valueOperations.set(String.valueOf(menu.getId()), menu, Duration.ofSeconds(120));</span><br><span class="line">        return menu;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第三步:定义用于处理菜单业务的业务接口实现类,基于AOP方式操作redis缓存,比较<br>与第二步写的Redis操作方式的不同,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line">package com.jt.service;</span><br><span class="line"></span><br><span class="line">import com.jt.dao.MenuMapper;</span><br><span class="line">import com.jt.pojo.Menu;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.cache.annotation.CachePut;</span><br><span class="line">import org.springframework.cache.annotation.Cacheable;</span><br><span class="line">import org.springframework.stereotype.Service;</span><br><span class="line"></span><br><span class="line">@Service</span><br><span class="line">public class DefaultMenuService implements MenuService&#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private MenuMapper menuMapper;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * 由此注解描述的方法为切入点方法,此方法执行时,底层会通过AOP机制</span><br><span class="line">     * 先从缓存取数据,缓存有则直接返回,缓存没有则查数据,最后将查询的数据</span><br><span class="line">     * 还会向redis存储一份</span><br><span class="line">     * @param id</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Cacheable(value = &quot;menuCache&quot;,key=&quot;#id&quot;)//打开redis，在springboot启动类加注解@EnableCaching</span><br><span class="line">    @Override</span><br><span class="line">    public Menu selectById(Long id) &#123;</span><br><span class="line">        return menuMapper.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    /**</span><br><span class="line">     * CachePut注解的意思是更新缓存</span><br><span class="line">     * @param menu</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @CachePut(value = &quot;menuCache&quot;,key=&quot;#menu.id&quot;)</span><br><span class="line">    @Override</span><br><span class="line">    public Menu insertMenu(Menu menu) &#123;</span><br><span class="line">         menuMapper.insert(menu);</span><br><span class="line">         return menu;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    @CachePut(value = &quot;menuCache&quot;,key=&quot;#menu.id&quot;)</span><br><span class="line">    @Override</span><br><span class="line">    public Menu updateMenu(Menu menu) &#123;</span><br><span class="line">        menuMapper.updateById(menu);</span><br><span class="line">        return menu;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>说明,启动AOP方式的缓存应用,需要在启动类上添加@EnableCaching注解:</p>
<p>第四步:定义单元测试类,基于单元测试类测试缓存应用.例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line">package com.jt;</span><br><span class="line"></span><br><span class="line">import com.jt.pojo.Menu;</span><br><span class="line">import com.jt.service.MenuService;</span><br><span class="line">import org.junit.jupiter.api.Test;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line">import org.springframework.boot.test.context.SpringBootTest;</span><br><span class="line"></span><br><span class="line">import javax.annotation.Resource;</span><br><span class="line"></span><br><span class="line">@SpringBootTest</span><br><span class="line">public class MenuServiceTests &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    @Qualifier(&quot;defaultMenuService&quot;)</span><br><span class="line">    //@Resource(name=&quot;defaultMenuService&quot;)</span><br><span class="line">    private MenuService menuService;</span><br><span class="line">    @Test</span><br><span class="line">    void testSelectById()&#123;</span><br><span class="line">        Menu menu = menuService.selectById(1L);</span><br><span class="line">        System.out.println(menu);</span><br><span class="line">    &#125;</span><br><span class="line">    @Test</span><br><span class="line">    void testUpdateMenu()&#123;</span><br><span class="line">        Menu menu = menuService.selectById(1L);</span><br><span class="line">        menu.setName(&quot;select res&quot;);</span><br><span class="line">        menuService.updateMenu(menu);</span><br><span class="line">    &#125;</span><br><span class="line">    @Test</span><br><span class="line">    void testInertMenu()&#123;</span><br><span class="line">        Menu menu = new Menu();</span><br><span class="line">        menu.setName(&quot;insert res&quot;);</span><br><span class="line">        menu.setPermission(&quot;sys:res:insert&quot;);</span><br><span class="line">        menuService.insertMenu(menu);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>第五步:改变AOP方式中redis数据存储时的序列化方式(假如业务上需要).其实现上要借助<br>CacheManager对象,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line">package com.jt;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.cache.CacheManager;</span><br><span class="line">import org.springframework.cache.annotation.CachingConfigurerSupport;</span><br><span class="line">import org.springframework.context.annotation.Bean;</span><br><span class="line">import org.springframework.context.annotation.Configuration;</span><br><span class="line">import org.springframework.context.annotation.Primary;</span><br><span class="line">import org.springframework.data.redis.cache.RedisCacheConfiguration;</span><br><span class="line">import org.springframework.data.redis.cache.RedisCacheManager;</span><br><span class="line">import org.springframework.data.redis.connection.RedisConnectionFactory;</span><br><span class="line">import org.springframework.data.redis.serializer.Jackson2JsonRedisSerializer;</span><br><span class="line">import org.springframework.data.redis.serializer.RedisSerializationContext;</span><br><span class="line">import org.springframework.data.redis.serializer.RedisSerializer;</span><br><span class="line"></span><br><span class="line">/**</span><br><span class="line"> * 重构CacheManager对象,其目的是改变AOP方式应用redis的序列化和反序列化的方式.</span><br><span class="line"> */</span><br><span class="line">@Configuration</span><br><span class="line">public class CacheManagerConfig &#123;</span><br><span class="line">    /**</span><br><span class="line">     * 重构CacheManager对象</span><br><span class="line">     * @return</span><br><span class="line">     */</span><br><span class="line">    @Bean</span><br><span class="line">    public CacheManager cacheManager(RedisConnectionFactory redisConnectionFactory) &#123;</span><br><span class="line">        //定义RedisCache配置</span><br><span class="line">        RedisCacheConfiguration cacheConfig=</span><br><span class="line">                RedisCacheConfiguration.defaultCacheConfig()</span><br><span class="line">        //定义key的序列化方式</span><br><span class="line">        .serializeKeysWith(</span><br><span class="line">                RedisSerializationContext.</span><br><span class="line">                   SerializationPair.fromSerializer(RedisSerializer.string()))</span><br><span class="line">        //定义value的序列化方式</span><br><span class="line">        .serializeValuesWith(</span><br><span class="line">                RedisSerializationContext.SerializationPair</span><br><span class="line">                .fromSerializer(RedisSerializer.json()));</span><br><span class="line"></span><br><span class="line">        return  RedisCacheManager.builder(redisConnectionFactory)</span><br><span class="line">               .cacheDefaults(cacheConfig)</span><br><span class="line">               .build();//建造者模式(复杂对象的创建,建议使用这种方式,封装了对象的创建细节)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>写好这个对象后,可以再次基于MenuService中的方法进行单元测试,检测redis数据的存储.</p>
<h3 id="Controller逻辑对象设计及实现"><a href="#Controller逻辑对象设计及实现" class="headerlink" title="Controller逻辑对象设计及实现"></a>Controller逻辑对象设计及实现</h3><p>第一步:定义Controller处理,处理客户端对菜单数据的请求操作,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><span class="line">package com.jt.controller;</span><br><span class="line">import com.jt.pojo.Menu;</span><br><span class="line">import com.jt.service.MenuService;</span><br><span class="line">import org.springframework.beans.factory.annotation.Autowired;</span><br><span class="line">import org.springframework.beans.factory.annotation.Qualifier;</span><br><span class="line">import org.springframework.web.bind.annotation.*;</span><br><span class="line">@RestController</span><br><span class="line">@RequestMapping(&quot;/menu&quot;)</span><br><span class="line">public class MenuController&#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    @Qualifier(&quot;defaultMenuService&quot;)</span><br><span class="line">    private MenuService menuService;</span><br><span class="line"></span><br><span class="line">    @GetMapping(&quot;/&#123;id&#125;&quot;)</span><br><span class="line">    public Menu doSelectById(@PathVariable(&quot;id&quot;) Long id)&#123;</span><br><span class="line">        return menuService.selectById(id);</span><br><span class="line">    &#125;</span><br><span class="line">    @PutMapping</span><br><span class="line">    public String doUpdate(@RequestBody Menu menu)&#123;</span><br><span class="line">         menuService.updateMenu(menu);</span><br><span class="line">         return &quot;update ok&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">    @PostMapping</span><br><span class="line">    public String doInsert(@RequestBody Menu menu)&#123;</span><br><span class="line">        menuService.insertMenu(menu);</span><br><span class="line">        return &quot;insert ok&quot;;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h1 id="持久化存储"><a href="#持久化存储" class="headerlink" title="持久化存储"></a>持久化存储</h1><p>redis.conf文件配置:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">配置准备工作</span><br><span class="line">第一步:从redis.io官方下载对应版本的redis.conf文件,地址</span><br><span class="line">https://redis.io/topics/config/</span><br><span class="line">第二步:停止redis并删除挂载目录下(/usr/local/docker/redis01/conf)的redis.conf配置文件.</span><br><span class="line">第三步:将下载的redis.conf文件拷贝到redis挂载目录(/usr/local/docker/redis01/conf)</span><br><span class="line">第四步:基于vim打开redis.conf文件,然后注释 bind 127.0.0.1这一行,并修改protected-mode的值修改为no.(java连接redis需要改这两项目)</span><br><span class="line">第五步:重启redis服务,并检查启动日志(docker logs 容器id)</span><br></pre></td></tr></table></figure>

<h2 id="RDB方式配置"><a href="#RDB方式配置" class="headerlink" title="RDB方式配置"></a>RDB方式配置</h2><p>Snapshotting</p>
<blockquote>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">下面介绍详细的快照保存过程：</span><br><span class="line">        1.redis 调用 fork,现在有了子进程和父进程。</span><br><span class="line">        2. 父进程继续处理 client 请求，子进程负责将内存内容写入到临时文件。由于 os 的实时复制机制（ copy on write)父子进程会共享相同的物理页面，当父进程处理写请求时 os 会为父进程要修改的页面创建副本，而不是写共享的页面。所以子进程地址空间内的数据是 fork时刻整个数据库的一个快照。</span><br><span class="line">        3.当子进程将快照写入临时文件完毕后，用临时文件替换原来的快照文件，然后子进程退出。client 也可以使用 save 或者 bgsave 命令通知 redis 做一次快照持久化。 save 操作是在主线程中保存快照的，由于 redis 是用一个主线程来处理所有 client 的请求，这种方式会阻塞所有client 请求。所以不推荐使用。另一点需要注意的是，每次快照持久化都是将内存数据完整写入到磁盘一次，并不是增量的只同步变更数据。如果数据量大的话，而且写操作比较多，必然会引起大量的磁盘 io 操作，可能会严重影响性能。</span><br></pre></td></tr></table></figure>
</blockquote>
<p>AOF方式</p>
<pre><code>    由于快照方式是在一定间隔时间做一次的，所以如果 redis 意外 down 掉的话，就会丢失最后一次快照后的所有修改。如果应用要求不能丢失任何修改的话，可以采用 aof 持久化方式。下面介绍 Append-only file:aof 比快照方式有更好的持久化性，是由于在使用 aof 持久化方式时,redis 会将每一个收到的写命令都通过 write 函数追加到文件中(默认是 appendonly.aof)。当 redis 重启时会通过重新执行文件中保存的写命令来在内存中重建整个数据库的内容。当然由于 os 会在内核中缓存 write 做的修改，所以可能不是立即写到磁盘上。这样 aof 方式的持久化也还是有可能会丢失部分修改。不过我们可以通过配置文件告诉 redis 我们想要通过 fsync 函数强制 os 写入到磁盘的时机。有三种方式如下（默认是：每秒 fsync 一次）
    appendonly yes //启用 aof 持久化方式
# appendfsync always //收到写命令就立即写入磁盘，最慢，但是保证完全的持久化
appendfsync everysec //每秒钟写入磁盘一次，在性能和持久化方面做了很好的折中
# appendfsync no //完全依赖 os，性能最好,持久化没保证
        aof 的方式也同时带来了另一个问题。持久化文件会变的越来越大。例如我们调用 incr test命令 100 次，文件中必须保存全部的 100 条命令，其实有 99 条都是多余的。因为要恢复数据库的状态其实文件中保存一条 set test 100 就够了。为了压缩 aof 的持久化文件。 redis 提供了 bgrewriteaof 命令。收到此命令 redis 将使用与快照类似的方式将内存中的数据以命令的方式保存到临时文件中，最后替换原来的文件。
</code></pre>
<p>快照是默认的持久化方式。RDB方式的持久化是默认开启的，也可按规则自己配置，例如，打开redis.conf文件，例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"># 这里表示每隔60s，如果有超过1000个key发生了变更，那么就生成一个新的dump.rdb文件，就是当前redis内存中完整的数据快照，这个操作也被称之为snapshotting(快照)。</span><br><span class="line">save 60 1000</span><br><span class="line"># 持久化 rdb文件遇到问题时，主进程是否接受写入，yes 表示停止写入，如果是no 表示redis继续提供服务。</span><br><span class="line">stop-writes-on-bgsave-error yes</span><br><span class="line"># 在进行快照镜像时,是否进行压缩。yes:压缩，但是需要一些cpu的消耗。no:不压缩，需要更多的磁盘空间。</span><br><span class="line">rdbcompression yes</span><br><span class="line"># 一个CRC64的校验就被放在了文件末尾，当存储或者加载rbd文件的时候会有一个10%左右的性能下降，为了达到性能的最大化，你可以关掉这个配置项。</span><br><span class="line">rdbchecksum yes</span><br><span class="line"># 快照的文件名</span><br><span class="line">dbfilename dump.rdb</span><br><span class="line"># 存放快照的目录</span><br><span class="line">dir /var/lib/redis</span><br></pre></td></tr></table></figure>

<p>手动调用save(同步保存)或者bgsave(异步保存)执行rdb快照生成.然后杀掉redis进程,再重启检测是否还有刚刚保存的数据.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set id 100</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set name jack</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; save  #阻塞式持久化</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set address beijing</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; bgsave  #异步方式持久化</span><br><span class="line">Background saving started</span><br></pre></td></tr></table></figure>

<p>RDB持久化机制有哪些优点？</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">第一：RDB会生成多个数据文件，每个数据文件都代表了某一个时刻中redis的数据，这种多个数据文件的方式，非常适合做冷备，可以将这种完整的数据文件发送到一些远程云服务上去，在国内可以是阿里云的ODPS分布式存储上，以预定好的备份策略来定期备份redis中的数据.</span><br><span class="line">第二：RDB对redis对外提供的读写服务，影响非常小，可以让redis保持高性能，因为redis主进程只需要fork一个子进程，让子进程执行磁盘IO操作来进行RDB持久化即可。</span><br><span class="line">第三：相对于AOF持久化机制来说，直接基于RDB数据文件来重启和恢复redis进程，更加快速。</span><br></pre></td></tr></table></figure>

<h2 id="Aof方式数据持久化"><a href="#Aof方式数据持久化" class="headerlink" title="Aof方式数据持久化"></a>Aof方式数据持久化</h2><h3 id="概述"><a href="#概述" class="headerlink" title="概述"></a>概述</h3><p>Aof方式是通过记录写操作日志的方式,记录redis数据的一种持久化机制,这个机制默认是关闭的。</p>
<h3 id="AOF方式配置"><a href="#AOF方式配置" class="headerlink" title="AOF方式配置"></a>AOF方式配置</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"># 是否开启AOF，默认关闭</span><br><span class="line">appendonly yes</span><br><span class="line"># 指定 AOF 文件名</span><br><span class="line">appendfilename appendonly.aof</span><br><span class="line"># Redis支持三种刷写模式：</span><br><span class="line"># appendfsync always #每次收到写命令就立即强制写入磁盘，类似MySQL的sync_binlog=1,是最安全的。但该模式下速度也是最慢的，一般不推荐使用。</span><br><span class="line">appendfsync everysec #每秒钟强制写入磁盘一次，在性能和持久化方面做平衡，推荐该方式。</span><br><span class="line"># appendfsync no     #完全依赖OS的写入，一般为30秒左右一次，性能最好但是持久化最没有保证，不推荐。</span><br><span class="line">    </span><br><span class="line">#在日志重写时，不进行命令追加操作，而只是将其放在缓冲区里，避免与命令的追加造成DISK IO上的冲突。</span><br><span class="line">#设置为yes表示rewrite期间对新写操作不fsync,暂时存在内存中,等rewrite完成后再写入，默认为no，建议yes</span><br><span class="line">no-appendfsync-on-rewrite yes</span><br><span class="line">#当前AOF文件大小是上次日志重写得到AOF文件大小的二倍时，自动启动新的日志重写过程。</span><br><span class="line">auto-aof-rewrite-percentage 100</span><br><span class="line">#当前AOF文件启动新的日志重写过程的最小值，避免刚刚启动Reids时由于文件尺寸较小导致频繁的重写。</span><br><span class="line">auto-aof-rewrite-min-size 64mb</span><br></pre></td></tr></table></figure>

<h3 id="AOF方式持久化实践"><a href="#AOF方式持久化实践" class="headerlink" title="AOF方式持久化实践"></a>AOF方式持久化实践</h3><p>第一：打开AOF的开关，启用AOF持久化<br>第二：写入一些数据，观察AOF文件（appendonly.aof）中的日志内容<br>第三：kill -9杀掉redis进程，重新启动redis进程，发现数据被恢复回来了，就是从AOF文件中恢复回来的，redis进程启动的时候，直接就会从appendonly.aof中加载所有的日志，把内存中的数据恢复回来。</p>
<h2 id="Redis-事务处理实践"><a href="#Redis-事务处理实践" class="headerlink" title="Redis 事务处理实践"></a>Redis 事务处理实践</h2><h3 id="基本指令"><a href="#基本指令" class="headerlink" title="基本指令"></a>基本指令</h3><p>redis进行事务控制时，通常是基于如下指令进行实现，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">multi 开启事务</span><br><span class="line">exec 提交事务</span><br><span class="line">discard 取消事务</span><br><span class="line">watch 监控，如果监控的值发生变化，则提交事务时会失败</span><br><span class="line">unwatch 去掉监控</span><br></pre></td></tr></table></figure>

<p>Redis保证一个事务中的所有命令要么都执行，要么都不执行(原子性)。如果在发送EXEC命令前客户端断线了，则Redis会清空事务队列，事务中的所有命令都不会执行。而一旦客户端发送了EXEC命令，所有的命令就都会被执行，即使此后客户端断线也没关系，因为Redis中已经记录了所有要执行的命令。</p>
<h3 id="Redis事务控制实践"><a href="#Redis事务控制实践" class="headerlink" title="Redis事务控制实践"></a>Redis事务控制实践</h3><h4 id="exec提交事务"><a href="#exec提交事务" class="headerlink" title="exec提交事务"></a>exec提交事务</h4><p>例如：模拟转账，tony 500，jack 200，tony转给jack100。过程如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set tony 500</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set jack 200</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; mget tony jack</span><br><span class="line">1) &quot;500&quot;</span><br><span class="line">2) &quot;200&quot;</span><br><span class="line">127.0.0.1:6379&gt; multi #开启事务</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379(TX)&gt; decrby tony 100 #所有指令操作会进入到队列</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; incrby jack 100</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379(TX)&gt; mget tony jack</span><br><span class="line">QUEUED </span><br><span class="line">127.0.0.1:6379(TX)&gt; exec  #提交事务</span><br><span class="line">1) (integer) 400</span><br><span class="line">2) (integer) 300</span><br><span class="line">3) 1) &quot;400&quot;</span><br><span class="line">   2) &quot;300&quot;</span><br><span class="line">127.0.0.1:6379&gt; mget tony jack</span><br><span class="line">1) &quot;400&quot;</span><br><span class="line">2) &quot;300&quot;</span><br></pre></td></tr></table></figure>

<h4 id="discard取消事务"><a href="#discard取消事务" class="headerlink" title="discard取消事务"></a>discard取消事务</h4><p>注意redis事务太简单，没有回滚，而只有取消。</p>
<p>当出现错误指令时，事务也会自动取消。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; mget tony jack</span><br><span class="line">1) &quot;400&quot;</span><br><span class="line">2) &quot;300&quot;</span><br><span class="line">127.0.0.1:6379&gt; multi</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; incrby jack 100</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; discard</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get jack</span><br><span class="line">&quot;300&quot;</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">(error) ERR EXEC without MULTI</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; set ticket 1</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; set money 0</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; watch ticket		#乐观锁，对值进行观察，改变则事务失败</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; multi				#开启事务</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; decr ticket</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; incrby money 100</span><br><span class="line">QUEUED</span><br><span class="line">127.0.0.1:6379&gt; exec</span><br><span class="line">(nil) #执行事务，失败</span><br><span class="line">127.0.0.1:6379&gt; get ticket</span><br><span class="line">“0”</span><br><span class="line">127.0.0.1:6379&gt; unwatch #取消监控</span><br></pre></td></tr></table></figure>

<h2 id="Redis架构设计"><a href="#Redis架构设计" class="headerlink" title="Redis架构设计"></a>Redis架构设计</h2><h4 id="Redis主从复制"><a href="#Redis主从复制" class="headerlink" title="Redis主从复制"></a>Redis主从复制</h4><h4 id="简介"><a href="#简介" class="headerlink" title="简介"></a>简介</h4><p>单个Redis支持的读写能力还是有限的,此时我们可以使用多个redis来提高redis的并发处理能力,这些redis如何协同,就需要有一定的架构设计,这里我们首先从主从(Master/Slave)架构进行分析和实现.</p>
<h4 id="基本架构"><a href="#基本架构" class="headerlink" title="基本架构"></a>基本架构</h4><p>redis主从架构如图所示</p>
<p><img src="https://s2.loli.net/2022/01/13/zUIOygfiDqF41oN.png" alt="image-20220113094231555"></p>
<h3 id="快速入门实践"><a href="#快速入门实践" class="headerlink" title="快速入门实践"></a>快速入门实践</h3><p>第一步:删除所有原有的redis容器,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker rm -f  redis容器名</span><br></pre></td></tr></table></figure>

<p>第二步：进入你的宿主机docker目录,然后将redis01拷贝两份，例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cp -r redis01/ redis02</span><br><span class="line">cp -r redis01/ redis03</span><br></pre></td></tr></table></figure>

<p>第三步：启动三个新的redis容器，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 6379:6379 --name redis6379 \</span><br><span class="line">-v /usr/local/docker/redis01/data:/data \</span><br><span class="line">-v /usr/local/docker/redis01/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d redis redis-server /etc/redis/redis.conf \</span><br><span class="line">--appendonly yes</span><br><span class="line"></span><br><span class="line">docker run -p 6380:6379 --name redis6380 \</span><br><span class="line">-v /usr/local/docker/redis02/data:/data \</span><br><span class="line">-v /usr/local/docker/redis02/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d redis redis-server /etc/redis/redis.conf \</span><br><span class="line">--appendonly yes</span><br><span class="line"></span><br><span class="line">docker run -p 6381:6379 --name redis6381 \</span><br><span class="line">-v /usr/local/docker/redis03/data:/data \  </span><br><span class="line">-v /usr/local/docker/redis03/conf/redis.conf:/etc/redis/redis.conf \</span><br><span class="line">-d redis redis-server /etc/redis/redis.conf \ </span><br><span class="line">--appendonly yes  #开启持久化</span><br></pre></td></tr></table></figure>

<p>说明:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">docker run -p 6380:6379 --name redis6380 端口映射加命名</span><br><span class="line">-v /root/redis/redis01/data:/data  容器 /data 映射到宿主机 /root/redis/redis01/data</span><br><span class="line">-d redis  后台模式启动 redis ,redis-server /etc/redis/redis.conf    redis 将以 /etc/redis/redis.conf 为配置文件启动</span><br><span class="line">--appendonly yes  #开启持久化</span><br></pre></td></tr></table></figure>

<p>第四步 检测redis服务角色</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br><span class="line"></span><br><span class="line">查看奴隶机</span><br><span class="line">\# Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:0</span><br><span class="line">master_repl_offset:3860</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:2</span><br><span class="line">repl_backlog_histlen:3859</span><br></pre></td></tr></table></figure>

<p>第五步：检测redis6379的ip设置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker inspect redis6379</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">……</span><br><span class="line">&quot;Networks&quot;: &#123;</span><br><span class="line">                &quot;bridge&quot;: &#123;</span><br><span class="line">                    &quot;IPAMConfig&quot;: null,</span><br><span class="line">                    &quot;Links&quot;: null,</span><br><span class="line">                    &quot;Aliases&quot;: null,</span><br><span class="line">                    &quot;NetworkID&quot;: &quot;c33071765cb48acb1efed6611615c767b04b98e6e298caa0dc845420e6112b73&quot;,</span><br><span class="line">                    &quot;EndpointID&quot;: &quot;4c77e3f458ea64b7fc45062c5b2b3481fa32005153b7afc211117d0f7603e154&quot;,</span><br><span class="line">                    &quot;Gateway&quot;: &quot;172.17.0.1&quot;,</span><br><span class="line">                    &quot;IPAddress&quot;: &quot;172.17.0.2&quot;,</span><br><span class="line">                    &quot;IPPrefixLen&quot;: 16,</span><br><span class="line">                    &quot;IPv6Gateway&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6Address&quot;: &quot;&quot;,</span><br><span class="line">                    &quot;GlobalIPv6PrefixLen&quot;: 0,</span><br><span class="line">                    &quot;MacAddress&quot;: &quot;02:42:ac:11:00:02&quot;,</span><br><span class="line">                    &quot;DriverOpts&quot;: null</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br></pre></td></tr></table></figure>

<p>第六步：设置Master/Slave架构</p>
<p>分别登陆redis6380/redis6381，然后执行如下语句</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">slaveof 172.17.0.2 6379 </span><br></pre></td></tr></table></figure>

<p>第七步：再次登陆redis6379，然后检测info</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7964 ~]# docker exec -it redis6379 redis-cli</span><br><span class="line">127.0.0.1:6379&gt; info replication</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">\# Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:2</span><br><span class="line">slave0:ip=172.17.0.3,port=6379,state=online,offset=2004,lag=1</span><br><span class="line">slave1:ip=172.17.0.4,port=6379,state=online,offset=2004,lag=1</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">........</span><br></pre></td></tr></table></figure>

<p>第八步: 登陆redis6379测试，master读写都可以</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7964 ~]# docker exec -it redis6379 redis-cli</span><br><span class="line">127.0.0.1:6379&gt; set role master6379</span><br><span class="line">OK</span><br><span class="line">127.0.0.1:6379&gt; get role</span><br><span class="line">&quot;master6379&quot;</span><br></pre></td></tr></table></figure>

<p>第九步: 登陆redis6380测试，slave只能读</p>
<p>查看docker日志</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker logs redis6380</span><br></pre></td></tr></table></figure>

<h2 id="Redis哨兵模式"><a href="#Redis哨兵模式" class="headerlink" title="Redis哨兵模式"></a>Redis哨兵模式</h2><p>架构图:</p>
<p><img src="https://s2.loli.net/2022/01/13/Rb5CIBgofMjpErq.png" alt="image-20220113112951839"></p>
<h3 id="哨兵快速入门"><a href="#哨兵快速入门" class="headerlink" title="哨兵快速入门"></a>哨兵快速入门</h3><p>第一步：打开三个redis客户端窗口，分别进入3台redis容器内部，在容器(Container)指定目录/etc/redis中执行如下语句：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/redis/sentinel.conf </span><br><span class="line">sentinel monitor redis6379 172.17.0.2 6379 1</span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>其中, 如上指令表示要的监控的master, redis6379为服务名, 172.17.0.2和6379为master的ip和端口,1表示多少个sentinel认为一个master失效时，master才算真正失效.</p>
<p>第二步：在每个redis容器内部的/etc/redis目录下执行如下指令，启动哨兵服务</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-sentinel sentinel.conf</span><br></pre></td></tr></table></figure>

<p>第三步：打开一个新的客户端连接窗口，关闭redis6379服务（这个服务是master服务）</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker stop redis6379</span><br></pre></td></tr></table></figure>

<p>在其它客户端窗口，检测日志输出，例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">410:X 11 Jul 2021 09:54:27.383 # +switch-master redis6379 172.17.0.2 6379 172.17.0.4 6379</span><br><span class="line">410:X 11 Jul 2021 09:54:27.383 * +slave slave 172.17.0.3:6379 172.17.0.3 6379 @ redis6379 172.17.0.4 6379</span><br><span class="line">410:X 11 Jul 2021 09:54:27.383 * +slave slave 172.17.0.2:6379 172.17.0.2 6379 @ redis6379 172.17.0.4 6379</span><br></pre></td></tr></table></figure>

<p>第四步：登陆ip为172.17.0.4对应的服务进行info检测，例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">127.0.0.1:6379&gt; info replication</span><br></pre></td></tr></table></figure>

<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">\# Replication</span><br><span class="line">role:master</span><br><span class="line">connected_slaves:1</span><br><span class="line">slave0:ip=172.17.0.3,port=6379,state=online,offset=222807,lag=0</span><br><span class="line">master_failover_state:no-failover</span><br><span class="line">master_replid:3d63e8474dd7bcb282ff38027d4a78c413cede53</span><br><span class="line">master_replid2:5baf174fd40e97663998abf5d8e89a51f7458488</span><br><span class="line">master_repl_offset:222807</span><br><span class="line">second_repl_offset:110197</span><br><span class="line">repl_backlog_active:1</span><br><span class="line">repl_backlog_size:1048576</span><br><span class="line">repl_backlog_first_byte_offset:29</span><br><span class="line">repl_backlog_histlen:222779</span><br></pre></td></tr></table></figure>

<p>从上面的信息输出发现,redis6381服务现在已经变为master。</p>
<h3 id="Sentinel-配置进阶"><a href="#Sentinel-配置进阶" class="headerlink" title="Sentinel 配置进阶"></a>Sentinel 配置进阶</h3><p>对于sentinel.conf文件中的内容,我们还可以基于实际需求,进行增强配置,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">sentinel monitor redis6379 172.17.0.2 6379 1 </span><br><span class="line">daemonize yes #后台运行</span><br><span class="line">logfile &quot;/var/log/sentinel_log.log&quot; #运行日志</span><br><span class="line">sentinel down-after-milliseconds redis6379 30000 #默认30秒</span><br></pre></td></tr></table></figure>

<p>其中:<br>1)daemonize yes表示后台运行(默认为no)<br>2)logfile 用于指定日志文件位置以及名字<br>3)sentinel down-after-milliseconds 表示master失效了多长时间才认为失效</p>
<p>例如: 基于cat指令创建sentinel.conf文件,并添加相关内容.</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">cat &lt;&lt;EOF &gt; /etc/redis/sentinel.conf</span><br><span class="line">sentinel monitor redis6379 172.17.0.2 6379 1</span><br><span class="line">daemonize yes </span><br><span class="line">logfile &quot;/var/log/sentinel_log.log&quot;</span><br><span class="line">sentinel down-after-milliseconds redis6379 30000 </span><br><span class="line">EOF</span><br></pre></td></tr></table></figure>

<p>哨兵工作原理分析<br>1)：每个Sentinel以每秒钟一次的频率向它所知的Master，Slave以及其他 Sentinel 实例发送一个 PING 命令。</p>
<p>2)：如果一个实例（instance）距离最后一次有效回复 PING 命令的时间超过 down-after-milliseconds 选项所指定的值(这个配置项指定了需要多少失效时间，一个master才会被这个sentinel主观地认为是不可用的。 单位是毫秒，默认为30秒)， 则这个实例会被 Sentinel 标记为主观下线。</p>
<p>3)：如果一个Master被标记为主观下线，则正在监视这个Master的所有 Sentinel 要以每秒一次的频率确认Master的确进入了主观下线状态。</p>
<p>4)：当有足够数量的 Sentinel（大于等于配置文件指定的值）在指定的时间范围内确认Master的确进入了主观下线状态， 则Master会被标记为客观下线 。</p>
<p>5)：在一般情况下， 每个 Sentinel 会以每 10 秒一次的频率向它已知的所有Master，Slave发送 INFO 命令 。</p>
<p>6)：当Master被 Sentinel 标记为客观下线时，Sentinel 向下线的 Master 的所有 Slave 发送 INFO 命令的频率会从 10 秒一次改为每秒一次 。</p>
<p>7)：若没有足够数量的 Sentinel 同意 Master 已经下线， Master 的客观下线状态就会被移除。<br>8): 若 Master 重新向 Sentinel 的 PING 命令返回有效回复， Master 的主观下线状态就会被移除。</p>
<h3 id="Redis集群高可用"><a href="#Redis集群高可用" class="headerlink" title="Redis集群高可用"></a>Redis集群高可用</h3><h3 id="基本架构-1"><a href="#基本架构-1" class="headerlink" title="基本架构"></a>基本架构</h3><p>对于redis集群(Cluster),一般最少设置为6个节点,3个master,3个slave,其简易架构如下:</p>
<p><img src="https://s2.loli.net/2022/01/13/A2oHZgQ4379kGNF.png" alt="image-20220113145044437"></p>
<h3 id="创建集群"><a href="#创建集群" class="headerlink" title="创建集群"></a>创建集群</h3><p>第一步：准备网络环境<br>创建虚拟网卡，主要是用于redis-cluster能于外界进行网络通信，一般常用桥接模式。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network create redis-net</span><br></pre></td></tr></table></figure>

<p>查看docker的网卡信息，可使用如下指令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network ls</span><br></pre></td></tr></table></figure>

<p>查看docker网络详细信息，可使用命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker network inspect redis-net</span><br></pre></td></tr></table></figure>

<p>第二步：准备redis配置模板</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">mkdir -p /usr/local/docker/redis-cluster</span><br><span class="line">cd /usr/local/docker/redis-cluster</span><br><span class="line">vim redis-cluster.tmpl</span><br></pre></td></tr></table></figure>

<p>在redis-cluster.tmpl中输入以下内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">port $&#123;PORT&#125;</span><br><span class="line">cluster-enabled yes</span><br><span class="line">cluster-config-file nodes.conf</span><br><span class="line">cluster-node-timeout 5000</span><br><span class="line">cluster-announce-ip 192.168.126.129</span><br><span class="line">cluster-announce-port $&#123;PORT&#125;</span><br><span class="line">cluster-announce-bus-port 1$&#123;PORT&#125;</span><br><span class="line">appendonly yes</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<p>各节点解释如下所示：</p>
<p>1.port：节点端口，即对外提供通信的端口<br>2.cluster-enabled：是否启用集群<br>3.cluster-config-file：集群配置文件<br>4.cluster-node-timeout：连接超时时间<br>5.cluster-announce-ip：宿主机ip<br>6.cluster-announce-port：集群节点映射端口<br>7.cluster-announce-bus-port：集群总线端口<br>8.appendonly：持久化模式</p>
<p>第三步：创建节点配置文件</p>
<p>在redis-cluser中执行以下命令</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">for port in $(seq 8010 8015); \</span><br><span class="line">do \</span><br><span class="line">  mkdir -p ./$&#123;port&#125;/conf  \</span><br><span class="line">  &amp;&amp; PORT=$&#123;port&#125; envsubst &lt; ./redis-cluster.tmpl &gt; ./$&#123;port&#125;/conf/redis.conf \</span><br><span class="line">  &amp;&amp; mkdir -p ./$&#123;port&#125;/data; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>其中：</p>
<ul>
<li><p>for 变量 in $(seq var1 var2);do …; done为linux中的一种shell 循环脚本, 例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[root@centos7964 ~]# for i in $(seq 1 5);</span><br><span class="line">&gt; do echo $i;</span><br><span class="line">&gt; done;</span><br><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td></tr></table></figure></li>
</ul>
<p>通过cat指令查看配置文件内容</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">cat /usr/local/docker/redis-cluster/801&#123;0..5&#125;/conf/redis.conf</span><br></pre></td></tr></table></figure>

<p>第四步：创建集群中的redis节点容器</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">for port in $(seq 8010 8015); \</span><br><span class="line">do \</span><br><span class="line">   docker run -it -d -p $&#123;port&#125;:$&#123;port&#125; -p 1$&#123;port&#125;:1$&#123;port&#125; \</span><br><span class="line">  --privileged=true -v /usr/local/docker/redis-cluster/$&#123;port&#125;/conf/redis.conf:/usr/local/etc/redis/redis.conf \</span><br><span class="line">  --privileged=true -v /usr/local/docker/redis-cluster/$&#123;port&#125;/data:/data \</span><br><span class="line">  --restart always --name redis-$&#123;port&#125; --net redis-net \</span><br><span class="line">  --sysctl net.core.somaxconn=1024 redis redis-server /usr/local/etc/redis/redis.conf; \</span><br><span class="line">done</span><br></pre></td></tr></table></figure>

<p>其中, –privileged=true表示让启动的容器用户具备真正root权限, –sysctl net.core.somaxconn=1024 这是一个linux的内核参数,用于设置请求队列大小,默认为128,后续启动redis的启动指令需要先放到这个请求队列中,然后依次启动.<br>创建成功以后，通过docker ps指令查看节点内容。</p>
<p>第五步：创建redis-cluster集群配置</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker exec -it redis-8010 bash</span><br></pre></td></tr></table></figure>

<p>如上指令要尽量放在一行执行，其中最后的1表示主从比例，当出现选择提示信息时，输入yes即可。当集群创建好以后,可以通过一些相关指令查看集群信息,例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">cluster nodes   #查看集群节点数</span><br><span class="line">cluster info #查看集群基本信息</span><br></pre></td></tr></table></figure>

<p>第六步：连接redis-cluster，并添加数据到redis</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">redis-cli -c -h 192.168.126.129 -p 8010</span><br></pre></td></tr></table></figure>

<p>其中,这里-c表示集群(cluster),-h表示host(一般写ip地址),-p为端口(port)</p>
<p><strong>其它：</strong><br>在搭建过程，可能在出现问题后，需要停止或直接删除docker容器，可以使用以下参考命令:</p>
<p>批量停止docker 容器,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a | grep -i &quot;redis-801*&quot; | awk &#x27;&#123;print $1&#125;&#x27; | xargs docker stop</span><br></pre></td></tr></table></figure>

<p>批量删除docker 容器,例如</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">docker ps -a | grep -i &quot;redis-801*&quot; | awk &#x27;&#123;print $1&#125;&#x27; | xargs docker rm -f</span><br></pre></td></tr></table></figure>

<p>批量删除文件,目录等,例如:</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">rm -rf 801&#123;0..5&#125;/conf/redis.conf</span><br><span class="line">rm -rf 801&#123;0..5&#125;</span><br></pre></td></tr></table></figure>

<p><img src="https://s2.loli.net/2022/01/13/15UxJznuqo7vCiF.png" alt="image-20220113173348903"></p>
<h3 id="Jedis读写数据测试"><a href="#Jedis读写数据测试" class="headerlink" title="Jedis读写数据测试"></a>Jedis读写数据测试</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line">@Test</span><br><span class="line">void testJedisCluster()throws Exception&#123;</span><br><span class="line">      Set&lt;HostAndPort&gt; nodes = new HashSet&lt;&gt;();</span><br><span class="line">      nodes.add(new HostAndPort(&quot;192.168.126.129&quot;,8010));</span><br><span class="line">      nodes.add(new HostAndPort(&quot;192.168.126.129&quot;,8011));</span><br><span class="line">      nodes.add(new HostAndPort(&quot;192.168.126.129&quot;,8012));</span><br><span class="line">      nodes.add(new HostAndPort(&quot;192.168.126.129&quot;,8013));</span><br><span class="line">      nodes.add(new HostAndPort(&quot;192.168.126.129&quot;,8014));</span><br><span class="line">      nodes.add(new HostAndPort(&quot;192.168.126.129&quot;,8015));</span><br><span class="line">      JedisCluster jedisCluster = new JedisCluster(nodes);</span><br><span class="line">      //使用jedisCluster操作redis</span><br><span class="line">      jedisCluster.set(&quot;test&quot;, &quot;cluster&quot;);</span><br><span class="line">      String str = jedisCluster.get(&quot;test&quot;);</span><br><span class="line">      System.out.println(str);</span><br><span class="line">      //关闭连接池</span><br><span class="line">      jedisCluster.close();</span><br><span class="line"> &#125;</span><br></pre></td></tr></table></figure>

<h3 id="RedisTemplate读写数据测试"><a href="#RedisTemplate读写数据测试" class="headerlink" title="RedisTemplate读写数据测试"></a>RedisTemplate读写数据测试</h3><p>第一步：配置application.yml,例如：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line">spring:</span><br><span class="line">  redis:</span><br><span class="line">    cluster: #redis 集群配置</span><br><span class="line">      nodes: 192.168.126.129:8010,192.168.126.129:8011,192.168.126.129:8012,192.168.126.129:8013,192.168.126.129:8014,192.168.126.129:8015</span><br><span class="line">      max-redirects: 3 #最大跳转次数</span><br><span class="line">    timeout: 5000 #超时时间</span><br><span class="line">    database: 0</span><br><span class="line">    jedis: #连接池</span><br><span class="line">      pool:</span><br><span class="line">        max-idle: 8</span><br><span class="line">        max-wait: 0</span><br></pre></td></tr></table></figure>

<p>第二步：编写单元测试类，代码如下：</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">package com.cy.redis;</span><br><span class="line">@SpringBootTest</span><br><span class="line">public class RedisClusterTests &#123;</span><br><span class="line">    @Autowired</span><br><span class="line">    private RedisTemplate redisTemplate;</span><br><span class="line">    @Test</span><br><span class="line">    void testMasterReadWrite()&#123;</span><br><span class="line">        //1.获取数据操作对象</span><br><span class="line">        ValueOperations valueOperations = redisTemplate.opsForValue();</span><br><span class="line">        //2.读写数据</span><br><span class="line">        valueOperations.set(&quot;city&quot;,&quot;beijing&quot;);</span><br><span class="line">        Object city=valueOperations.get(&quot;city&quot;);</span><br><span class="line">        System.out.println(city);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="缓存穿透（查不到）和雪崩"><a href="#缓存穿透（查不到）和雪崩" class="headerlink" title="缓存穿透（查不到）和雪崩"></a>缓存穿透（查不到）和雪崩</h3><p><img src="https://s2.loli.net/2022/01/18/Ib8ei7dPgKRLBzq.png" alt="image-20220118092046272"></p>
<p>用户想要查询一个数据，发现redis内存数据没有，也就是缓存中没有，于是就向持久层数据库查询，发现也没有，于是本次查询失败，当用户很多的时候，缓存都没有命中，于是都去请i去了持久层数据库，这给持久层造成很大的压力，这时候就相当于出现了缓存穿透。</p>
<h3 id="解决办法："><a href="#解决办法：" class="headerlink" title="解决办法："></a>解决办法：</h3><p><img src="https://s2.loli.net/2022/01/18/aAVJzQN6wWcntox.png" alt="image-20220118092557779"></p>
<p><img src="https://s2.loli.net/2022/01/18/dFp4YkwnAocO1lr.png" alt="image-20220118092632125"></p>
<p>但是这种方法或存在两个问题:</p>
<p>1.如果空值能够被缓存起来，这就意味着缓存需要更多的空间存储更多的键，因为这当中可能会有很多的空值的键。</p>
<p>2.即使对空值设置了过期时间，函数会存在缓存层和存储层有一段时间窗口的不一致，这对于需要保持一致性的业务有影响。</p>
<h3 id="缓存击穿-量太大"><a href="#缓存击穿-量太大" class="headerlink" title="缓存击穿(量太大)"></a>缓存击穿(量太大)</h3><p>微博服务器宕机</p>
<p><img src="https://s2.loli.net/2022/01/18/3qhl1NAoQs4K8dz.png" alt="image-20220118093030682"></p>
<h4 id="解决方案"><a href="#解决方案" class="headerlink" title="解决方案"></a>解决方案</h4><p>数据永不过期</p>
<p>加互斥锁：使用分布式锁，保证每个key同时只有一个线程去查询后端服务，其他线程等待。这种方式将高并发的压力转移到分布式锁，对分布式锁考验较大。</p>
<h4 id="缓存雪崩"><a href="#缓存雪崩" class="headerlink" title="缓存雪崩"></a>缓存雪崩</h4><p>在某一段时间，缓存集中国企失效。redis宕机。</p>
<p><img src="https://s2.loli.net/2022/01/18/PVykXIZxpb2BdiN.png" alt="image-20220118093659482"></p>
<p><img src="https://s2.loli.net/2022/01/18/suL8FVIp2wlahd5.png" alt="image-20220118094030979"></p>
<h4 id=""><a href="#" class="headerlink" title=""></a></h4>
            <!--[if lt IE 9]><script>document.createElement('audio');</script><![endif]-->
            <audio id="audio" loop="1" preload="auto" controls="controls" data-autoplay="false">
                <source type="audio/mpeg" src="">
            </audio>
            
                <ul id="audio-list" style="display:none">
                    
                        
                            <li title="0" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                        
                            <li title="1" data-url="http://link.hhtjim.com/163/425570952.mp3"></li>
                        
                    
                </ul>
            
        </div>
        
    <div id="gitalk-container" class="comment link"
		data-enable="false"
        data-ae="false"
        data-ci=""
        data-cs=""
        data-r=""
        data-o=""
        data-a=""
        data-d="false"
    >查看评论</div>


    </div>
    
</div>


    </div>
</div>
</body>


<script src="//lib.baomitu.com/jquery/1.8.3/jquery.min.js"></script>
<script src="/js/plugin.js"></script>
<script src="/js/typed.js"></script>
<script src="/js/diaspora.js"></script>


<link rel="stylesheet" href="/photoswipe/photoswipe.css">
<link rel="stylesheet" href="/photoswipe/default-skin/default-skin.css">


<script src="/photoswipe/photoswipe.min.js"></script>
<script src="/photoswipe/photoswipe-ui-default.min.js"></script>


<!-- Root element of PhotoSwipe. Must have class pswp. -->
<div class="pswp" tabindex="-1" role="dialog" aria-hidden="true">
    <!-- Background of PhotoSwipe. 
         It's a separate element as animating opacity is faster than rgba(). -->
    <div class="pswp__bg"></div>
    <!-- Slides wrapper with overflow:hidden. -->
    <div class="pswp__scroll-wrap">
        <!-- Container that holds slides. 
            PhotoSwipe keeps only 3 of them in the DOM to save memory.
            Don't modify these 3 pswp__item elements, data is added later on. -->
        <div class="pswp__container">
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
            <div class="pswp__item"></div>
        </div>
        <!-- Default (PhotoSwipeUI_Default) interface on top of sliding area. Can be changed. -->
        <div class="pswp__ui pswp__ui--hidden">
            <div class="pswp__top-bar">
                <!--  Controls are self-explanatory. Order can be changed. -->
                <div class="pswp__counter"></div>
                <button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
                <button class="pswp__button pswp__button--share" title="Share"></button>
                <button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
                <button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button>
                <!-- Preloader demo http://codepen.io/dimsemenov/pen/yyBWoR -->
                <!-- element will get class pswp__preloader--active when preloader is running -->
                <div class="pswp__preloader">
                    <div class="pswp__preloader__icn">
                      <div class="pswp__preloader__cut">
                        <div class="pswp__preloader__donut"></div>
                      </div>
                    </div>
                </div>
            </div>
            <div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap">
                <div class="pswp__share-tooltip"></div> 
            </div>
            <button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)">
            </button>
            <button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)">
            </button>
            <div class="pswp__caption">
                <div class="pswp__caption__center"></div>
            </div>
        </div>
    </div>
</div>






</html>
